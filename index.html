import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  updateDoc, 
  setDoc,
  deleteDoc, 
  onSnapshot, 
  query 
} from 'firebase/firestore';

/**
 * BY AGATA - DASHBOARD ADMIN PREMIUM (VERSI CLOUD + LOGIN)
 */

// Konfigurasi Firebase dari Environment
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'by-agata-admin-v1';

// --- KOMPONEN IKON SVG (Mencegah Error Library Eksternal) ---
const Icon = ({ name, size = 20, className = "" }) => {
  const icons = {
    plus: <path d="M12 5v14M5 12h14" />,
    search: <React.Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></React.Fragment>,
    package: <React.Fragment><path d="M16.5 9.4 7.5 4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" y1="22" x2="12" y2="12"/></React.Fragment>,
    trash: <React.Fragment><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></React.Fragment>,
    check: <polyline points="20 6 9 17 4 12"/>,
    edit: <React.Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></React.Fragment>,
    printer: <React.Fragment><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></React.Fragment>,
    wallet: <React.Fragment><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></React.Fragment>,
    eye: <React.Fragment><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></React.Fragment>,
    eyeOff: <React.Fragment><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.52 13.52 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></React.Fragment>,
    logout: <React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></React.Fragment>,
    lock: <React.Fragment><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></React.Fragment>,
    download: <React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></React.Fragment>
  };
  return (
    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
      {icons[name] || null}
    </svg>
  );
};

const App = () => {
  // --- LOGIN STATES ---
  const [isLoggedIn, setIsLoggedIn] = useState(() => localStorage.getItem('agata_authenticated') === 'true');
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [loginError, setLoginError] = useState(false);

  // --- DATABASE STATES ---
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('orders'); 
  const [orders, setOrders] = useState([]);
  const [gowns, setGowns] = useState([]);
  const [storeSettings, setStoreSettings] = useState({ namaBank: '', namaRekening: 'BY AGATA', nomorRekening: '' });
  
  // --- UI STATES ---
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [successMsg, setSuccessMsg] = useState(null);
  const [showOmset, setShowOmset] = useState(true);
  const [isEditing, setIsEditing] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [viewOrderDetail, setViewOrderDetail] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');

  // --- FORM STATE ---
  const [orderFormData, setOrderFormData] = useState({
    admin: '', namaCustomer: '', noTlp: '', kodeGaun: '', 
    totalHarga: '', nominalDP: '', tglDP: '', tglPelunasan: '', 
    tglPenyerahan: '', tglPengembalian: ''
  });

  // --- AUTH INITIALIZATION ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        setError("Gagal sinkronisasi keamanan.");
        setLoading(false);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- DATA FETCHING ---
  useEffect(() => {
    if (!user) return;

    const ordersCol = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    const unsubOrders = onSnapshot(query(ordersCol), (snapshot) => {
      setOrders(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      setLoading(false);
    }, () => setError("Gagal memuat data pesanan."));

    const gownsCol = collection(db, 'artifacts', appId, 'public', 'data', 'gowns');
    const unsubGowns = onSnapshot(query(gownsCol), (snapshot) => {
      setGowns(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });

    const settingsDoc = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'storeInfo');
    const unsubSettings = onSnapshot(settingsDoc, (snap) => {
      if (snap.exists()) setStoreSettings(snap.data());
    });

    return () => { unsubOrders(); unsubGowns(); unsubSettings(); };
  }, [user]);

  useEffect(() => {
    if (successMsg) {
      const timer = setTimeout(() => setSuccessMsg(null), 3000);
      return () => clearTimeout(timer);
    }
  }, [successMsg]);

  // --- LOGIKA LOGIN ---
  const handleLogin = (e) => {
    e.preventDefault();
    if (username === 'agata' && password === 'agata123') {
      setIsLoggedIn(true);
      localStorage.setItem('agata_authenticated', 'true');
      setLoginError(false);
    } else {
      setLoginError(true);
    }
  };

  const handleLogout = () => {
    setIsLoggedIn(false);
    localStorage.removeItem('agata_authenticated');
  };

  // --- ACTIONS ---
  const handleOrderSubmit = async (e) => {
    e.preventDefault();
    if (!user) return;

    const total = parseFloat(orderFormData.totalHarga) || 0;
    const dpVal = parseFloat(orderFormData.nominalDP) || 0;
    const isLunas = orderFormData.tglPelunasan !== '';

    const data = {
      ...orderFormData,
      totalHarga: total,
      nominalDP: isLunas ? total : dpVal,
      status: isLunas ? "Lunas" : "DP",
      updatedAt: new Date().toISOString()
    };

    try {
      if (isEditing) {
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', editingId), data);
        setIsEditing(false); setEditingId(null);
      } else {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), { ...data, createdAt: new Date().toISOString() });
      }
      setOrderFormData({ admin: '', namaCustomer: '', noTlp: '', kodeGaun: '', totalHarga: '', nominalDP: '', tglDP: '', tglPelunasan: '', tglPenyerahan: '', tglPengembalian: '' });
      setSuccessMsg("Pesanan Berhasil Disimpan!");
    } catch (err) { setError("Gagal menyimpan ke Cloud."); }
  };

  const handleMarkAsPaid = async (e, id) => {
    e.stopPropagation();
    if (!user) return;
    const order = orders.find(o => o.id === id);
    if (!order) return;
    try {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { 
        status: "Lunas", 
        tglPelunasan: new Date().toISOString().split('T')[0],
        nominalDP: order.totalHarga 
      });
      setSuccessMsg("Lunas!");
    } catch (err) { setError("Gagal update status."); }
  };

  const deleteItem = async (type, id) => {
    if (!confirm("Hapus data secara permanen dari Cloud?")) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', type, id));
      setSuccessMsg("Data Terhapus.");
    } catch (err) { setError("Gagal menghapus."); }
  };

  const printReceipt = (order) => {
    const isLunas = order.status === 'Lunas';
    const sisa = isLunas ? 0 : (parseFloat(order.totalHarga) || 0) - (parseFloat(order.nominalDP) || 0);
    const bayar = isLunas ? order.totalHarga : (order.nominalDP || 0);

    const win = window.open('', '_blank');
    win.document.write(`
      <html><head><title>Nota Agata - ${order.namaCustomer}</title>
      <style>
        body{font-family:sans-serif;padding:30px;color:#333;line-height:1.5;} 
        .header{text-align:center;border-bottom:2px solid #f43f5e;margin-bottom:20px;padding-bottom:10px;} 
        .header h1{margin:0;color:#f43f5e;letter-spacing:1px;}
        .row{display:flex;justify-content:space-between;margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:5px;} 
        .price-box{background:#fff1f2;padding:15px;border-radius:12px;margin-top:20px;} 
        .grand{font-size:24px;color:#f43f5e;font-weight:900;}
      </style></head>
      <body>
        <div class="header"><h1>BY AGATA</h1><p>Luxury Boutique Rental</p></div>
        <div class="row"><span>Customer:</span><strong>${order.namaCustomer}</strong></div>
        <div class="row"><span>Kode Gaun:</span><strong>${order.kodeGaun}</strong></div>
        <div class="row"><span>WhatsApp:</span><strong>${order.noTlp}</strong></div>
        <div class="row"><span>Tgl Kembali:</span><strong>${order.tglPengembalian || '-'}</strong></div>
        <div class="price-box">
          <div class="row" style="border:none"><span>Total:</span><span>Rp ${parseFloat(order.totalHarga).toLocaleString('id-ID')}</span></div>
          <div class="row" style="border:none"><span>Bayar:</span><span>Rp ${parseFloat(bayar).toLocaleString('id-ID')}</span></div>
          <div class="row grand" style="border-top:2px dashed #ffccd5; padding-top:10px; margin-top:5px;"><span>SISA:</span><span>Rp ${sisa.toLocaleString('id-ID')}</span></div>
        </div>
        <div style="background:#fafafa;padding:15px;border-radius:10px;margin-top:20px;font-size:12px;border:1px solid #eee;">
          <p style="margin:0 0 5px;font-weight:bold;color:#f43f5e;">TRANSFER PELUNASAN:</p>
          <p style="margin:2px 0;">Bank: <strong>${storeSettings.namaBank}</strong></p>
          <p style="margin:2px 0;">No Rek: <strong>${storeSettings.nomorRekening}</strong></p>
          <p style="margin:2px 0;">A/N: <strong>${storeSettings.namaRekening}</strong></p>
        </div>
        <script>window.onload=function(){window.print();}</script>
      </body></html>
    `);
    win.document.close();
  };

  const filteredOrders = useMemo(() => {
    let res = [...orders];
    if (searchTerm) res = res.filter(o => o.namaCustomer?.toLowerCase().includes(searchTerm.toLowerCase()));
    return res;
  }, [orders, searchTerm]);

  const totalOmset = orders.reduce((acc, curr) => acc + (parseFloat(curr.totalHarga) || 0), 0);

  // --- SCREEN LOGIN ---
  if (!isLoggedIn) {
    return (
      <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
        <div className="bg-white w-full max-w-md p-10 rounded-[3rem] shadow-2xl border-t-[10px] border-rose-500">
          <div className="text-center mb-10">
            <div className="bg-rose-50 text-rose-500 p-5 rounded-[2rem] w-fit mx-auto mb-4">
              <Icon name="lock" size={32} />
            </div>
            <h1 className="text-3xl font-black text-slate-800 tracking-tighter">By Agata Admin</h1>
            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mt-2">Sistem Manajemen Butik</p>
          </div>
          <form onSubmit={handleLogin} className="space-y-4">
            <input required className="w-full p-4 rounded-2xl border bg-slate-50 outline-none focus:ring-4 focus:ring-rose-100 font-bold" placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} />
            <input required type="password" className="w-full p-4 rounded-2xl border bg-slate-50 outline-none focus:ring-4 focus:ring-rose-100 font-bold" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} />
            {loginError && <p className="text-center text-rose-500 text-[10px] font-black uppercase">Username atau Sandi Salah!</p>}
            <button type="submit" className="w-full py-5 bg-rose-500 text-white rounded-2xl font-black shadow-xl hover:bg-rose-600 transition-all uppercase tracking-widest text-xs">Masuk Sekarang</button>
          </form>
          <p className="text-center mt-8 text-[10px] font-black text-slate-300 uppercase tracking-widest leading-relaxed">Keamanan Data Terenkripsi Cloud Google</p>
        </div>
      </div>
    );
  }

  // --- SCREEN DASHBOARD ---
  if (loading) return (
    <div className="min-h-screen flex items-center justify-center bg-slate-50 flex-col gap-6">
      <div className="w-12 h-12 border-4 border-rose-100 border-t-rose-500 rounded-full animate-spin"></div>
      <p className="text-slate-400 font-black tracking-widest text-[10px] uppercase animate-pulse">Menghubungkan ke Cloud Agata...</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 font-sans pb-24 text-slate-800">
      {/* Header */}
      <nav className="bg-white/80 backdrop-blur-md border-b px-6 py-4 sticky top-0 z-50 flex justify-between items-center shadow-sm">
        <div className="flex items-center gap-2">
          <div className="bg-rose-500 p-2 rounded-xl text-white shadow-lg"><Icon name="package" size={20}/></div>
          <h1 className="text-2xl font-black tracking-tighter">By Agata</h1>
        </div>
        <div className="flex items-center gap-4">
          <div className="text-right border-r pr-4 border-slate-100 hidden sm:block">
            <p className="text-[10px] uppercase font-black text-slate-400 leading-none mb-1">Total Omset</p>
            <p className="font-black text-rose-600 leading-none text-lg">{showOmset ? `Rp ${totalOmset.toLocaleString('id-ID')}` : "Rp •••••"}</p>
          </div>
          <button onClick={() => setShowOmset(!showOmset)} className="p-2.5 bg-slate-50 rounded-xl text-slate-400 hover:text-rose-500 transition-all">
            <Icon name={showOmset ? "eyeOff" : "eye"} size={20}/>
          </button>
          <button onClick={handleLogout} className="p-2.5 bg-rose-50 text-rose-500 rounded-xl hover:bg-rose-500 hover:text-white transition-all">
            <Icon name="logout" size={20}/>
          </button>
        </div>
      </nav>

      {/* Alert Notif */}
      {successMsg && <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-8 py-3 rounded-2xl shadow-2xl font-black text-[10px] uppercase tracking-widest animate-in slide-in-from-top border-b-4 border-rose-500">{successMsg}</div>}

      {/* Tabs */}
      <div className="max-w-md mx-auto flex p-1.5 bg-white/80 backdrop-blur-md rounded-3xl shadow-sm border mt-8 gap-1.5 sticky top-24 z-40">
        <button onClick={() => setActiveTab('orders')} className={`flex-1 py-3 rounded-2xl text-[10px] font-black tracking-widest transition-all ${activeTab === 'orders' ? 'bg-rose-500 text-white shadow-xl shadow-rose-200' : 'text-slate-400 hover:bg-slate-50'}`}>PESANAN</button>
        <button onClick={() => setActiveTab('gowns')} className={`flex-1 py-3 rounded-2xl text-[10px] font-black tracking-widest transition-all ${activeTab === 'gowns' ? 'bg-rose-500 text-white shadow-xl shadow-rose-200' : 'text-slate-400 hover:bg-slate-50'}`}>GAUN</button>
        <button onClick={() => setActiveTab('settings')} className={`flex-1 py-3 rounded-2xl text-[10px] font-black tracking-widest transition-all ${activeTab === 'settings' ? 'bg-slate-800 text-white shadow-xl shadow-slate-200' : 'text-slate-400 hover:bg-slate-50'}`}>REKENING</button>
      </div>

      <main className="max-w-7xl mx-auto p-4 mt-4">
        {activeTab === 'orders' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-1">
              <section className="bg-white p-8 rounded-[3rem] shadow-sm border space-y-6">
                <h2 className="font-black text-2xl tracking-tighter flex items-center gap-2 underline decoration-rose-200 decoration-8 underline-offset-[-2px]">{isEditing ? 'Update Data' : 'Input Pesanan'}</h2>
                <form onSubmit={handleOrderSubmit} className="space-y-4">
                  <input required className="w-full p-4 rounded-2xl border bg-slate-50 outline-none focus:ring-4 focus:ring-rose-500/10 font-bold" placeholder="Nama Admin" value={orderFormData.admin} onChange={e => setOrderFormData({...orderFormData, admin: e.target.value})} />
                  <input required className="w-full p-4 rounded-2xl border bg-slate-50 outline-none focus:ring-4 focus:ring-rose-500/10 font-bold" placeholder="Nama Customer" value={orderFormData.namaCustomer} onChange={e => setOrderFormData({...orderFormData, namaCustomer: e.target.value})} />
                  <input required className="w-full p-4 rounded-2xl border bg-slate-50 outline-none focus:ring-4 focus:ring-rose-500/10 font-bold" placeholder="WhatsApp (08xx)" value={orderFormData.noTlp} onChange={e => setOrderFormData({...orderFormData, noTlp: e.target.value})} />
                  <div className="grid grid-cols-2 gap-3">
                    <input required className="w-full p-4 rounded-2xl border bg-slate-50 font-black uppercase" placeholder="Kode Gaun" value={orderFormData.kodeGaun} onChange={e => setOrderFormData({...orderFormData, kodeGaun: e.target.value})} />
                    <input required type="number" className="w-full p-4 rounded-2xl border bg-slate-50 font-black" placeholder="Total Rp" value={orderFormData.totalHarga} onChange={e => setOrderFormData({...orderFormData, totalHarga: e.target.value})} />
                  </div>
                  <div className="bg-rose-50 p-6 rounded-[2.5rem] border border-rose-100">
                    <label className="text-[10px] font-black text-rose-400 uppercase tracking-widest block mb-1">DP Masuk (Bayar Awal)</label>
                    <input type="number" className="w-full bg-transparent border-b-2 border-rose-200 outline-none font-black text-rose-600 text-xl py-1" value={orderFormData.nominalDP} onChange={e => setOrderFormData({...orderFormData, nominalDP: e.target.value})} />
                  </div>
                  <div className="grid grid-cols-2 gap-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    <div className="space-y-1 ml-1 font-bold">Penyerahan<input type="date" className="w-full p-3.5 rounded-2xl border bg-white mt-1 font-black" value={orderFormData.tglPenyerahan} onChange={e => setOrderFormData({...orderFormData, tglPenyerahan: e.target.value})} /></div>
                    <div className="space-y-1 ml-1 text-rose-500 font-bold">Kembali<input type="date" className="w-full p-3.5 rounded-2xl border border-rose-100 bg-rose-50/50 mt-1 font-black text-rose-600" value={orderFormData.tglPengembalian} onChange={e => setOrderFormData({...orderFormData, tglPengembalian: e.target.value})} /></div>
                  </div>
                  <button type="submit" className="w-full py-5 bg-rose-500 text-white rounded-[1.8rem] font-black shadow-2xl active:scale-95 transition-all text-xs tracking-widest uppercase">Simpan ke Cloud</button>
                  {isEditing && <button type="button" onClick={() => { setIsEditing(false); setEditingId(null); }} className="w-full text-slate-400 text-[10px] font-black uppercase tracking-widest mt-2 hover:text-rose-500">Batalkan Edit</button>}
                </form>
              </section>
            </div>

            <div className="lg:col-span-2 space-y-6">
              <div className="bg-white p-5 rounded-[2rem] border flex gap-4 items-center shadow-sm">
                <div className="flex-1 relative group">
                  <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-rose-500 transition-colors" size={18} />
                  <input className="w-full pl-12 pr-4 py-3 rounded-2xl bg-slate-50 border-none outline-none text-sm font-bold" placeholder="Cari Nama Customer..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                </div>
              </div>
              <div className="bg-white rounded-[2.5rem] border overflow-hidden shadow-sm">
                <div className="overflow-x-auto">
                  <table className="w-full text-left">
                    <thead className="bg-slate-50/80 border-b text-[10px] font-black uppercase text-slate-400 tracking-widest">
                      <tr><th className="px-8 py-7">Customer</th><th className="px-8 py-7 text-right">Tagihan</th><th className="px-8 py-7 text-center">Opsi</th></tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {filteredOrders.map(o => {
                        const isLunas = o.status === 'Lunas';
                        return (
                          <tr key={o.id} onClick={() => setViewOrderDetail(o)} className="hover:bg-slate-50 cursor-pointer transition-colors group">
                            <td className="px-8 py-8">
                              <p className="font-black text-slate-800 text-xl leading-tight mb-1 tracking-tight uppercase">{o.namaCustomer}</p>
                              <div className="flex gap-2 items-center">
                                <span className="text-[10px] font-black text-rose-500 uppercase bg-rose-50 px-2 py-0.5 rounded-lg border border-rose-100 leading-none">{o.kodeGaun}</span>
                                <span className="text-[10px] font-bold text-slate-400 italic leading-none">By {o.admin}</span>
                              </div>
                            </td>
                            <td className="px-8 py-8 text-right">
                              <p className="font-black text-slate-800 text-lg">Rp {parseFloat(o.totalHarga).toLocaleString('id-ID')}</p>
                              <span className={`text-[10px] font-black uppercase px-3 py-1 rounded-full border ${isLunas ? 'bg-emerald-100 text-emerald-600 border-emerald-200' : 'bg-amber-100 text-amber-600 border-amber-200'}`}>{o.status}</span>
                            </td>
                            <td className="px-8 py-8 flex justify-center gap-2 opacity-10 group-hover:opacity-100 transition-all">
                              {!isLunas && <button onClick={(e) => handleMarkAsPaid(e, o.id)} className="p-3 text-emerald-500 bg-emerald-50 rounded-2xl hover:bg-emerald-500 hover:text-white shadow-sm transition-all"><Icon name="check" size={20}/></button>}
                              <button onClick={(e) => { e.stopPropagation(); setIsEditing(true); setEditingId(o.id); setOrderFormData(o); window.scrollTo({top:0, behavior:'smooth'}); }} className="p-3 text-blue-500 bg-blue-50 rounded-2xl hover:bg-blue-500 hover:text-white shadow-sm transition-all"><Icon name="edit" size={20}/></button>
                              <button onClick={(e) => { e.stopPropagation(); deleteItem('orders', o.id); }} className="p-3 text-rose-300 bg-rose-50 rounded-2xl hover:bg-rose-500 hover:text-white shadow-sm transition-all"><Icon name="trash" size={20}/></button>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                  {orders.length === 0 && <div className="p-32 text-center text-slate-300 font-black italic tracking-widest text-sm uppercase">Belum ada data online</div>}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'gowns' && (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 animate-in fade-in duration-500">
            {gowns.map(g => (
              <div key={g.id} className="bg-white p-8 rounded-[3rem] border flex justify-between items-center group shadow-sm hover:border-rose-400 transition-all duration-300">
                <div>
                  <p className="font-black text-slate-800 text-lg tracking-tight uppercase">{g.namaGaun}</p>
                  <div className="flex items-center gap-2 mt-1">
                    <span className="text-[10px] font-black bg-slate-900 text-white px-2 py-0.5 rounded-md uppercase tracking-widest leading-none">{g.kodeGaun}</span>
                    <span className="text-xs font-bold text-rose-500">Rp {parseFloat(g.hargaGaun).toLocaleString('id-ID')}</span>
                  </div>
                </div>
                <button onClick={() => deleteItem('gowns', g.id)} className="p-3 text-slate-100 group-hover:text-rose-500 bg-slate-50 group-hover:bg-rose-50 rounded-2xl transition-colors"><Icon name="trash" size={20}/></button>
              </div>
            ))}
            <button className="bg-slate-100 border-4 border-dashed border-slate-200 p-12 rounded-[3rem] flex flex-col items-center justify-center text-slate-400 gap-3 hover:bg-slate-200 transition-all" onClick={() => {
              const n = prompt("Nama Gaun:"); const k = prompt("Kode Gaun:"); const h = prompt("Harga:");
              if(n && k && h) addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'gowns'), { namaGaun: n, kodeGaun: k, hargaGaun: h, createdAt: new Date().toISOString() });
            }}>
              <Icon name="plus" size={48}/>
              <span className="font-black text-[10px] uppercase tracking-widest">Tambah Katalog Gaun</span>
            </button>
          </div>
        )}

        {activeTab === 'settings' && (
          <div className="max-w-lg mx-auto bg-white p-12 rounded-[4rem] border shadow-2xl space-y-10 animate-in zoom-in">
            <div className="text-center space-y-3">
              <div className="bg-slate-900 text-white p-6 rounded-[2rem] w-fit mx-auto shadow-2xl rotate-3"><Icon name="wallet" size={40}/></div>
              <h2 className="text-3xl font-black tracking-tighter">Rekening Toko</h2>
              <p className="text-slate-400 text-[10px] font-bold uppercase tracking-widest px-6 leading-relaxed">Informasi transfer otomatis tercetak pada Nota Digital.</p>
            </div>
            <div className="space-y-5">
              <input className="w-full p-5 rounded-[1.5rem] border bg-slate-50 font-black outline-none focus:ring-4 focus:ring-slate-100 tracking-tight" placeholder="Nama Bank" value={storeSettings.namaBank} onChange={e => setStoreSettings({...storeSettings, namaBank: e.target.value})} />
              <input className="w-full p-5 rounded-[1.5rem] border bg-slate-50 font-black outline-none focus:ring-4 focus:ring-slate-100 tracking-tight" placeholder="Nomor Rekening" value={storeSettings.nomorRekening} onChange={e => setStoreSettings({...storeSettings, nomorRekening: e.target.value})} />
              <input className="w-full p-5 rounded-[1.5rem] border bg-slate-50 font-black uppercase outline-none focus:ring-4 focus:ring-slate-100 tracking-tight" placeholder="Atas Nama" value={storeSettings.namaRekening} onChange={e => setStoreSettings({...storeSettings, namaRekening: e.target.value})} />
              <button onClick={() => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'storeInfo'), storeSettings).then(() => setSuccessMsg("Update Berhasil!"))} className="w-full py-6 bg-rose-500 text-white rounded-[2rem] font-black shadow-2xl active:scale-95 transition-all text-xs tracking-[0.2em] uppercase mt-4">Simpan Perubahan</button>
            </div>
          </div>
        )}
      </main>

      {/* Detail Modal */}
      {viewOrderDetail && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md fade-in">
          <div className="bg-white w-full max-w-sm rounded-[3.5rem] shadow-2xl overflow-hidden animate-in zoom-in duration-300">
            <div className="bg-rose-500 p-12 text-white relative overflow-hidden">
              <div className="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full"></div>
              <button onClick={() => setViewOrderDetail(null)} className="absolute top-6 right-6 p-2 hover:bg-white/20 rounded-full transition-colors"><Icon name="plus" className="rotate-45" size={32}/></button>
              <p className="text-[10px] font-black uppercase opacity-60 mb-3 tracking-[0.3em] relative">Rincian Sewa Digital</p>
              <h3 className="text-4xl font-black leading-none tracking-tighter relative uppercase">{viewOrderDetail.namaCustomer}</h3>
              <div className="flex gap-2 mt-4 relative">
                <span className="bg-white text-rose-500 text-[10px] font-black px-2.5 py-1 rounded-lg uppercase">Gaun: {viewOrderDetail.kodeGaun}</span>
                <span className="bg-rose-600 text-white text-[10px] font-black px-2.5 py-1 rounded-lg uppercase">{viewOrderDetail.status}</span>
              </div>
            </div>
            <div className="p-10 space-y-6">
              <div className="space-y-4">
                <div className="flex justify-between border-b border-slate-50 pb-2 text-xs font-bold text-slate-400 tracking-widest uppercase"><span>Kontak</span><span className="text-slate-800 font-black">{viewOrderDetail.noTlp}</span></div>
                <div className="flex justify-between border-b border-slate-50 pb-2 text-xs font-bold text-slate-400 tracking-widest uppercase"><span>Penyerahan</span><span className="text-blue-500 font-black">{viewOrderDetail.tglPenyerahan || '-'}</span></div>
                <div className="flex justify-between border-b border-slate-50 pb-2 text-xs font-bold text-slate-400 tracking-widest uppercase"><span>Kembali</span><span className="text-rose-500 font-black underline decoration-2">{viewOrderDetail.tglPengembalian || '-'}</span></div>
              </div>
              <div className="bg-slate-900 p-7 rounded-[2.5rem] text-white mt-8 shadow-2xl relative overflow-hidden">
                <div className="absolute right-0 bottom-0 opacity-10 p-2"><Icon name="package" size={80}/></div>
                <p className="text-[10px] opacity-50 uppercase mb-2 font-black tracking-widest relative">Kekurangan Tagihan</p>
                <p className="text-3xl font-black text-rose-400 tracking-tighter relative">Rp {(viewOrderDetail.status === 'Lunas' ? 0 : (parseFloat(viewOrderDetail.totalHarga) - (parseFloat(viewOrderDetail.nominalDP) || 0))).toLocaleString('id-ID')}</p>
              </div>
              <button onClick={() => printReceipt(viewOrderDetail)} className="w-full py-5 bg-rose-500 text-white font-black py-5 rounded-[1.8rem] flex items-center justify-center gap-3 shadow-2xl active:scale-95 transition-all text-xs tracking-widest uppercase"><Icon name="printer" size={20}/> Cetak Nota</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
